blueprint:
  name: LLM Script for Light Control
  source_url: https://github.com/music-assistant/voice-support/blob/main/llm-script-blueprint/llm_voice_script.yaml
  domain: script
  author: Brendan (adapted from Music Assistant LLM blueprint)
  homeassistant:
    min_version: 2024.6.0
  description: |
    # Creates a script which will allow voice requests for Light Control
    
    * No changes are required for any of the settings below for this script to work,
    but your specific LLM integration may need some fine-tuning. To do that, adjust
    the prompts sent to the LLM.
    
    * **Make sure to expose the script to Assist after creating it.**
    * **Make sure to give the script a clear description.** An example can be found below.
    * It is possible to add additional actions to be performed after the light service calls.
    
    ## Example for script description
    `This script controls lights based on voice requests. Use for turn on/off, dim/brighten, color changes. Specify target (ceiling light living room, upstairs, bedroom, all) and parameters (brightness 50%, red, transition 5s). Use this tool for all light control requests.`
    
    ## Available variables for additional actions
    |Variable|Description|
    |---|---|
    |`target`|What LLM resolved target to (e.g. <light_id>, <area_id>, "upstairs", "house")|
    |`action`|The action: turn_on, turn_off, toggle, dim, brighten|
    |`target_data`|Clean target dict (entity_id OR floor_id OR area_id only)|
    |`clean_target`|Final service target used|
    |`brightness_pct`|Brightness percentage 0-100|

  input:
    light_settings:
      name: Light Settings
      icon: mdi:lightbulb
      description: Configure default area for light control
      input:
        default_area:
          name: Default Area
          description: Fallback area if no target specified
          selector:
            area: {}
          default: {}

    prompt_settings:
      name: Prompt settings for the LLM
      icon: mdi:robot
      description: Fine-tune prompts for your specific LLM model. Defaults work well.
      collapsed: true
      input:
        action_prompt:
          name: Action Prompt
          description: Prompt for light action
          selector:
            text:
              multiline: true
          default: |
            This argument is mandatory! "action" can only be:
            - "turn_on" - turn lights on
            - "turn_off" - turn lights off  
            - "toggle" - toggle light state
            - "dim" - reduce brightness (use brightness_pct: 30-70)
            - "brighten" - increase brightness (use brightness_pct: 70-100)
            For "dim the lights" use action: "dim", brightness_pct: 50. For "make brighter" use "brighten", brightness_pct: 80.

    target_prompt:
      name: Target Prompt
      description: Prompt for target resolution
      selector:
        text:
          multiline: true
      default: |
        You receive:
        - The full list of available light entities with their `entity_id` and `friendly_name`.
        - The list of valid `area_id` and `floor_id` values for this specific house.
    
        Your job is to:
        1. Select EXACTLY ONE target type:
           - SPECIFIC ENTITY: choose when the user refers to a specific light or group.
           - AREA: when the user mentions a room/area.
           - FLOOR: when the user mentions a whole floor.
           - ALL: "everywhere", "whole house" → all floors.
    
        2. You MUST only use names that exist in the provided lists:
           - Never invent or normalize room names.
           - Example: if the only area is "living" (area_id: living), **never** use "living room".
           - If there is an area "living_room" and aliases "living", "sitting area", you **must** map
             all of these back to `living_room`.

        3. Priority order:
           1. SPECIFIC ENTITY (best match in friendly_name).
           2. AREA (valid area_id only).
           3. FLOOR (valid floor_id only).
           4. ALL (special keywords only).
    
        4. Rules:
           - NEVER mix types. "ceiling light in <room>" = ENTITY, not area.
           - If the user says something that does not match any known entity/area/floor, return an empty target.
           - Never output partial or guessed area names; always exactly match an existing `area_id` or entity name.

        Examples:
           - "turn off <area>" → target: "<aream>"
           - "dim upstairs" → target: "upstairs"
           - "make <light> in <area> red" → target: "<light>"

        brightness_prompt:
          name: Brightness Prompt
          selector:
            text:
              multiline: true
          default: |
            "brightness_pct": 0-100 (0=off, 100=max). 
            dim→40-60, brighten→70-90, "half"→50, "full"→100.
            Only use if light supports brightness (check supported_features).

        color_prompt:
          name: Color Prompt
          selector:
            text:
              multiline: true
          default: |
            Only if light supports color (check supported_color_modes):
            - "color_name": "red", "blue", "warm_white"
            - "rgb_color": "[255,0,0]" (list format)
            - "color_temp_kelvin": 2700-6500
            Skip if unsupported.

        transition_prompt:
          name: Transition Prompt
          selector:
            text:
              multiline: true
          default: |
            "transition": seconds (0.5, 1, 3, 5). Use for smooth changes.

    additional_actions:
      name: Additional actions
      icon: mdi:wrench
      description: Actions after light control (notify, scenes, etc.). Variables; target, action, brightness_pct, color_name available.
      collapsed: true
      input:
        actions:
          name: Additional actions
          selector:
            action: {}
          default: []

mode: parallel
max_exceeded: silent

description: |
  This script controls lights based on voice requests. Use for turn on/off, dim/brighten, color changes. 
  Specify target (ceiling light living room, upstairs, bedroom, all) and parameters (brightness 50%, red, transition 5s). 
  Use this tool for all light control requests.

fields:
  action:
    selector:
      select:
        options:
          - turn_on
          - turn_off
          - toggle
          - dim
          - brighten
    name: Action
    description: !input action_prompt
    required: true
  
  target:
    selector:
      text: {}
    name: Target
    description: !input target_prompt
    required: true
  
  brightness_pct:
    selector:
      number:
        min: 0
        max: 100
        step: 1
        mode: slider
    name: Brightness %
    description: !input brightness_prompt
  
  color_name:
    selector:
      text: {}
    name: Color Name
    description: !input color_prompt
  
  rgb_color:
    selector:
      text: {}
    name: RGB Color
    description: !input color_prompt
  
  color_temp_kelvin:
    selector:
      number:
        min: 2000
        max: 6500
    name: Color Temp Kelvin
    description: !input color_prompt
  
  transition:
    selector:
      number:
        min: 0
        max: 30
        step: 0.1
    name: Transition (seconds)
    description: !input transition_prompt

sequence:
  - variables:
      raw_target: "{{ target | lower | trim }}"
      raw_action: "{{ action }}"

      brightness_pct_final: >
        {% set pct = brightness_pct | default(0) | int %}
        {% if raw_action == 'dim' %}
          {{ [pct, 40] | max | default(50) }}
        {% elif raw_action == 'brighten' %}
          {{ [pct, 70] | min | default(80) }}
        {% else %}
          {{ pct }}
        {% endif %}
      
      # 1. ENTITY fuzzy matching (PRIORITY 1)
      entity_match: >
        {% set ns = namespace(entities=[]) %}
        {% for light in states.light %}
          {% if raw_target in (light.friendly_name | lower | default('')) or raw_target in (light.name | lower) %}
            {% set ns.entities = ns.entities + [light.entity_id] %}
          {% endif %}
        {% endfor %}
        {{ ns.entities }}
      
      # 2. FLOOR check (your floors: "upstairs", "downstairs")
      is_floor: "{{ raw_target in ['upstairs', 'downstairs'] }}"
      
      # 3. AREA check
      is_area: >
        {{ states.area | selectattr('entity_id', 'search', '^area\\.' ~ raw_target ~ '$') | list | count > 0 }}
      
      target_data:
        entity_id: "{{ entity_match if entity_match else 'NA' }}"
        area_id: "{{ [raw_target] if is_area and not entity_match else 'NA' }}"
        floor_id: "{{ [raw_target] if is_floor and not entity_match and not is_area else 'NA' }}"
      
      service_name: >
        {% if raw_action in ['dim', 'brighten'] %} light.turn_on
        {% else %} light.{{ raw_action }} {% endif %}
      
      clean_target: >
        {% if target_data.entity_id != 'NA' %}
          {"entity_id": {{ target_data.entity_id }}}
        {% elif target_data.area_id != 'NA' %}
          {"area_id": {{ target_data.area_id }}}
        {% elif target_data.floor_id != 'NA' %}
          {"floor_id": {{ target_data.floor_id }}}          
        {% elif raw_target in ['all', 'everywhere', 'house', 'whole house'] %}
          {"floor_id": ["upstairs", "downstairs"]}
        {% else %}
          {}
        {% endif %}
      
      service_data: >
        {% set data = namespace(dict={}) %}
        {% if brightness_pct_final is defined and brightness_pct_final > 0 %}
          {% set data.dict = data.dict | combine({'brightness_pct': brightness_pct_final}) %}
        {% endif %}
        {% if color_name is defined and color_name and color_name != '' %}
          {% set data.dict = data.dict | combine({'color_name': color_name}) %}
        {% endif %}
        {% if rgb_color is defined and rgb_color and rgb_color != '' %}
          {% set data.dict = data.dict | combine({'rgb_color': rgb_color}) %}
        {% endif %}
        {% if color_temp_kelvin is defined and color_temp_kelvin and color_temp_kelvin != 0 %}
          {% set data.dict = data.dict | combine({'color_temp_kelvin': color_temp_kelvin | int}) %}
        {% endif %}
        {% if transition is defined and transition and transition != 0 %}
          {% set data.dict = data.dict | combine({'transition': transition | float}) %}
        {% endif %}
        {{ data.dict }}



  # Execute (music blueprint style)
  - service: "{{ service_name }}"
    target: "{{ clean_target }}"
    data: "{{ service_data }}"
    continue_on_error: true
  
  - sequence: !input actions

